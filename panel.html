<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Panel de Control - Lodeltirry</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <style>
      body {
        background: #111;
        color: #fff;
        font-family: sans-serif;
        margin: 0;
        padding: 0;
      }
      h1 {
        text-align: center;
        padding: 1rem;
        background: #d40000;
        margin: 0;
      }
      .container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        padding: 1rem;
      }
      .card {
        background: #1a1a1a;
        padding: 1rem;
        border-radius: 10px;
      }
      .card h2 {
        margin-top: 0;
      }
      input,
      button {
        padding: 0.5rem;
        margin-top: 0.5rem;
        border-radius: 5px;
        border: none;
      }
      button {
        cursor: pointer;
        background: #d40000;
        color: #fff;
      }
      .message {
        margin-top: 0.5rem;
        padding: 0.3rem 0.5rem;
        border-radius: 5px;
      }
      .success {
        background: green;
      }
      .error {
        background: crimson;
      }
      .warning {
        background: orange;
      }
      .days-container button {
        margin: 0.2rem;
        padding: 0.3rem 0.6rem;
        border-radius: 5px;
      }
      .days-container button.active {
        background: green;
        color: #fff;
      }
      .time-slot {
        display: inline-block;
        margin: 0.2rem;
        padding: 0.3rem 0.5rem;
        border: 1px solid #444;
        border-radius: 5px;
        cursor: pointer;
      }
      .time-slot.active {
        background: #d40000;
        color: #fff;
      }
      .reservas-list {
        max-height: 300px;
        overflow-y: auto;
      }
      .reserva-item {
        padding: 0.5rem;
        border-bottom: 1px solid #444;
      }
    </style>
  </head>
  <body>
    <h1>
      #LODELTIRRY <br /><small
        >Panel de Control - Administración de Reservas</small
      >
    </h1>

    <div class="container">
      <!-- Configuración de precios -->
      <div class="card">
        <h2>Configuración de Precios</h2>
        <label>Precio del Corte de Pelo ($)</label><br />
        <input type="number" id="service-price" />
        <button id="save-price">
          <i class="fas fa-save"></i> Guardar Precio
        </button>
        <div id="price-message"></div>
      </div>

      <!-- Gestión de días no disponibles -->
      <div class="card">
        <h2>Gestión de Días No Disponibles</h2>
        <div class="days-container" id="days-container"></div>
        <button id="save-days">
          <i class="fas fa-save"></i> Guardar Días No Disponibles
        </button>
      </div>

      <!-- Gestión de horarios -->
      <div class="card" style="grid-column: 1/3">
        <h2>Gestión de Horarios Disponibles por Día</h2>
        <div id="weekdays-container"></div>
        <button id="save-times">
          <i class="fas fa-save"></i> Guardar Horarios
        </button>
      </div>

      <!-- Reservas -->
      <div class="card" style="grid-column: 1/3">
        <h2>Reservas por Día</h2>
        <input type="date" id="filter-date" />
        <button id="load-reservations">Cargar Reservas</button>
        <div id="reservas-container" class="reservas-list"></div>
      </div>
    </div>

    <script>
      const BACKEND_URL = "https://gestor-turnos-yv0m.onrender.com";

      const priceInput = document.getElementById("service-price");
      const priceMessage = document.getElementById("price-message");

      const daysContainer = document.getElementById("days-container");
      const weekdaysContainer = document.getElementById("weekdays-container");
      const reservasContainer = document.getElementById("reservas-container");

      const filterDate = document.getElementById("filter-date");

      let unavailableDays = JSON.parse(
        localStorage.getItem("unavailableDays") || "[]"
      );
      let availableTimes = JSON.parse(
        localStorage.getItem("availableTimes") || "{}"
      );

      /* ---------- Configuración de precios ---------- */
      async function loadPrice() {
        try {
          const res = await fetch(`${BACKEND_URL}/api/config`);
          if (!res.ok) throw new Error("Error obteniendo precio");
          const data = await res.json();
          priceInput.value = data.price;
        } catch (err) {
          console.error(err);
          // fallback a localStorage si el backend falla
          priceInput.value = localStorage.getItem("servicePrice") || 2500;
        }
      }

      async function savePrice() {
        const price = priceInput.value;
        try {
          const res = await fetch(`${BACKEND_URL}/api/config?price=${price}`, {
            method: "PUT",
          });
          if (!res.ok) throw new Error("Error guardando precio");
          priceMessage.innerHTML = `<div class="message success">Precio actualizado correctamente</div>`;
        } catch (err) {
          console.error(err);
          // fallback a localStorage
          localStorage.setItem("servicePrice", price);
          priceMessage.innerHTML = `<div class="message warning">Guardado en modo local (backend no disponible)</div>`;
        }
        // enviar a index.html
        window.postMessage({ type: "priceUpdate", price }, "*");
      }

      /* ---------- Días no disponibles ---------- */
      function renderDays() {
        daysContainer.innerHTML = "";
        const names = [
          "Domingo",
          "Lunes",
          "Martes",
          "Miércoles",
          "Jueves",
          "Viernes",
          "Sábado",
        ];
        names.forEach((day, i) => {
          const btn = document.createElement("button");
          btn.textContent = day;
          if (unavailableDays.includes(i)) btn.classList.add("active");
          btn.addEventListener("click", () => {
            if (unavailableDays.includes(i)) {
              unavailableDays = unavailableDays.filter((d) => d !== i);
            } else {
              unavailableDays.push(i);
            }
            renderDays();
          });
          daysContainer.appendChild(btn);
        });
      }

      function saveDays() {
        localStorage.setItem(
          "unavailableDays",
          JSON.stringify(unavailableDays)
        );
        window.postMessage(
          { type: "unavailableDaysUpdate", days: unavailableDays },
          "*"
        );
        alert("Días guardados correctamente");
      }

      /* ---------- Horarios ---------- */
      function renderTimes() {
        weekdaysContainer.innerHTML = "";
        const names = [
          "Domingo",
          "Lunes",
          "Martes",
          "Miércoles",
          "Jueves",
          "Viernes",
          "Sábado",
        ];
        names.forEach((day, i) => {
          const div = document.createElement("div");
          div.innerHTML = `<h3>${day}</h3>`;
          let dayTimes = availableTimes[i] || [];
          for (let hour = 8; hour <= 19; hour++) {
            const h1 = `${hour}:00`,
              h2 = `${hour}:30`;
            [h1, h2].forEach((t) => {
              const slot = document.createElement("div");
              slot.classList.add("time-slot");
              slot.textContent = t;
              if (dayTimes.includes(t)) slot.classList.add("active");
              slot.addEventListener("click", () => {
                if (dayTimes.includes(t)) {
                  dayTimes = dayTimes.filter((x) => x !== t);
                } else {
                  dayTimes.push(t);
                }
                availableTimes[i] = dayTimes;
                renderTimes();
              });
              div.appendChild(slot);
            });
          }
          weekdaysContainer.appendChild(div);
        });
      }

      function saveTimes() {
        localStorage.setItem("availableTimes", JSON.stringify(availableTimes));
        window.postMessage(
          { type: "availableTimesUpdate", times: availableTimes },
          "*"
        );
        alert("Horarios guardados correctamente");
      }

      /* ---------- Reservas ---------- */
      async function loadReservations() {
        reservasContainer.innerHTML = "";
        const dateVal = filterDate.value;
        if (!dateVal) {
          reservasContainer.innerHTML =
            "<div class='message warning'>Seleccioná una fecha</div>";
          return;
        }
        try {
          const res = await fetch(`${BACKEND_URL}/api/reservations`);
          if (!res.ok) throw new Error("Error cargando reservas");
          const data = await res.json();
          const filtered = data.filter((r) => r.date === dateVal);
          if (filtered.length === 0) {
            reservasContainer.innerHTML =
              "<div class='message'>No hay reservas</div>";
            return;
          }
          filtered.forEach((r) => {
            const div = document.createElement("div");
            div.classList.add("reserva-item");
            div.textContent = `${r.clientName} - ${r.phone} - ${r.time}`;
            reservasContainer.appendChild(div);
          });
        } catch (err) {
          console.error(err);
          reservasContainer.innerHTML =
            "<div class='message error'>Error cargando reservas</div>";
        }
      }

      /* ---------- Init ---------- */
      document.addEventListener("DOMContentLoaded", () => {
        loadPrice();
        renderDays();
        renderTimes();
        document
          .getElementById("save-price")
          .addEventListener("click", savePrice);
        document
          .getElementById("save-days")
          .addEventListener("click", saveDays);
        document
          .getElementById("save-times")
          .addEventListener("click", saveTimes);
        document
          .getElementById("load-reservations")
          .addEventListener("click", loadReservations);
      });
    </script>
  </body>
</html>
