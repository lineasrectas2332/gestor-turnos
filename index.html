<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Reservas - #lodeltirry</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      :root {
        --primary: #36494e;
        --primary-dark: #597081;
        --secondary: #7ea0b7;
        --light: #a9cef4;
        --lighter: #f0f7ff;
        --gray: #9e9e9e;
        --light-gray: #d1d5db;
        --background: #f8fafc;
        --surface: #ffffff;
        --card: #ffffff;
        --hover: #7ea0b7;
        --success: #10b981;
        --error: #ef4444;
        --text: #000000;
        --text-light: #4b5563;
        --unavailable: #f51b0b;
        --pending: #f59e0b;
        --accent: #a9cef4;
        --border: #e5e7eb;
        --focus: #a9cef4;
        --section-border: #7ea0b7;
        --time-slot-bg: #e6f0ff;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      body {
        background-color: var(--background);
        color: var(--text);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 15px;
        line-height: 1.6;
      }

      .container {
        width: 100%;
        max-width: 800px;
        background-color: var(--surface);
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.12);
        border: 2px solid var(--section-border);
      }

      .header {
        background: linear-gradient(
          135deg,
          var(--primary),
          var(--primary-dark)
        );
        padding: 28px 25px;
        text-align: center;
        position: relative;
        color: white;
        border-bottom: 3px solid var(--secondary);
      }

      .logo {
        font-size: 30px;
        font-weight: 800;
        letter-spacing: 1.8px;
        margin-bottom: 8px;
        color: white;
        text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      }

      .subtitle {
        font-size: 16px;
        opacity: 0.92;
        margin-bottom: 12px;
        font-weight: 400;
      }

      .price-tag {
        background-color: rgba(255, 255, 255, 0.25);
        color: white;
        padding: 8px 18px;
        border-radius: 24px;
        font-weight: 600;
        display: inline-block;
        margin-top: 10px;
        font-size: 14px;
        backdrop-filter: blur(6px);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .calendar-container {
        padding: 25px;
      }

      .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 2px solid var(--light);
      }

      .month-nav {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .nav-btn {
        background-color: var(--light);
        color: var(--primary-dark);
        border: none;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
        transition: all 0.3s ease;
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.12);
        border: 1px solid var(--accent);
      }

      .nav-btn:hover {
        background-color: var(--secondary);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 5px 12px rgba(126, 160, 183, 0.3);
      }

      .current-month {
        font-size: 22px;
        font-weight: 700;
        color: var(--primary);
        text-align: center;
        flex-grow: 1;
        min-width: 200px;
      }

      .calendar {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 30px;
        border: 1px solid var(--border);
        border-radius: 10px;
        overflow: hidden;
      }

      .calendar th {
        padding: 14px 0;
        text-align: center;
        color: var(--primary-dark);
        font-weight: 600;
        font-size: 14px;
        border-bottom: 2px solid var(--light);
        background-color: var(--lighter);
      }

      .calendar td {
        text-align: center;
        padding: 12px 0;
        cursor: pointer;
        transition: all 0.3s ease;
        border-radius: 8px;
        position: relative;
        height: 46px;
        border: 1px solid var(--border);
      }

      .calendar
        td:hover:not(.inactive):not(.past):not(.reserved-day):not(
          .unavailable-day
        ):not(.pending-day) {
        background-color: var(--accent);
        color: var(--primary-dark);
      }

      .calendar td.active {
        background-color: var(--primary);
        color: white;
        box-shadow: 0 4px 12px rgba(54, 73, 78, 0.25);
      }

      .calendar td.inactive,
      .calendar td.past {
        color: var(--gray);
        cursor: not-allowed;
        opacity: 0.5;
        background-color: #f9fafb;
      }

      .calendar td.reserved-day {
        position: relative;
        cursor: not-allowed;
        opacity: 0.7;
        background-color: #fef2f2;
      }

      .calendar td.reserved-day .day-number {
        text-decoration: line-through;
        color: var(--error);
      }

      .calendar td.unavailable-day {
        position: relative;
        cursor: not-allowed;
        opacity: 0.7;
        background-color: #fffbeb;
      }

      .calendar td.unavailable-day .day-number {
        text-decoration: line-through;
        color: var(--unavailable);
      }

      .calendar td.pending-day {
        position: relative;
        cursor: not-allowed;
        opacity: 0.7;
        background-color: #fffbeb;
      }

      .calendar td.pending-day .day-number {
        text-decoration: line-through;
        color: var(--pending);
      }

      .day-number {
        font-size: 15px;
        font-weight: 500;
        display: inline-block;
        width: 36px;
        height: 36px;
        line-height: 36px;
        border-radius: 50%;
        transition: all 0.3s ease;
      }

      .today .day-number {
        background-color: var(--secondary);
        color: white;
        font-weight: bold;
        box-shadow: 0 2px 6px rgba(126, 160, 183, 0.3);
      }

      .turns-section {
        background-color: var(--card);
        border-radius: 12px;
        padding: 20px;
        margin: 20px 0;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        border: 2px solid var(--light);
        background: linear-gradient(to bottom, #ffffff, #f8fafc);
      }

      .turns-title {
        font-size: 18px;
        margin-bottom: 15px;
        color: var(--primary-dark);
        display: flex;
        align-items: center;
        gap: 10px;
        padding-bottom: 10px;
        border-bottom: 2px solid var(--light);
      }

      .turns-title i {
        color: var(--secondary);
        font-size: 20px;
      }

      .time-slots-container {
        background-color: var(--time-slot-bg);
        border-radius: 10px;
        padding: 15px;
        border: 1px solid var(--accent);
      }

      .time-slots {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(95px, 1fr));
        gap: 12px;
        margin-bottom: 15px;
      }

      .time-slot {
        background-color: var(--light);
        border: 2px solid var(--light);
        border-radius: 10px;
        padding: 10px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        color: var(--primary-dark);
        font-size: 14px;
        font-weight: 500;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      }

      .time-slot:hover {
        background-color: var(--secondary);
        border-color: var(--secondary);
        color: white;
        transform: translateY(-3px);
        box-shadow: 0 5px 12px rgba(126, 160, 183, 0.3);
      }

      .time-slot.selected {
        background-color: var(--primary-dark);
        border-color: var(--primary-dark);
        color: white;
        font-weight: 600;
        box-shadow: 0 5px 12px rgba(89, 112, 129, 0.3);
        transform: translateY(-2px);
      }

      .time-slot.disabled {
        opacity: 0.4;
        cursor: not-allowed;
        background-color: var(--light-gray);
        border-color: var(--light-gray);
        color: var(--gray);
      }

      .time-slot.reserved {
        background-color: var(--error);
        border-color: var(--error);
        color: white;
        cursor: not-allowed;
      }

      .time-slot.pending {
        background-color: var(--pending);
        border-color: var(--pending);
        color: white;
        cursor: not-allowed;
      }

      .selection-info {
        background: linear-gradient(135deg, #e6f0ff, #d4e5ff);
        border-radius: 10px;
        padding: 15px;
        margin: 15px 0;
        border: 2px solid var(--accent);
        border-left: 5px solid var(--secondary);
      }

      .selection-info .message {
        margin: 0;
        font-weight: 600;
        color: var(--primary-dark);
      }

      .confirmation-section {
        background-color: var(--card);
        border-radius: 12px;
        padding: 20px;
        margin-top: 20px;
        display: none;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        border: 2px solid var(--light);
        background: linear-gradient(to bottom, #ffffff, #f8fafc);
      }

      .confirmation-title {
        font-size: 18px;
        margin-bottom: 18px;
        color: var(--primary-dark);
        display: flex;
        align-items: center;
        gap: 10px;
        padding-bottom: 10px;
        border-bottom: 2px solid var(--light);
      }

      .confirmation-title i {
        color: var(--success);
        font-size: 20px;
      }

      .selected-info {
        background: linear-gradient(135deg, var(--lighter), var(--light));
        border-radius: 10px;
        padding: 16px;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border: 2px solid var(--accent);
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.08);
      }

      .selected-date,
      .selected-time {
        display: flex;
        align-items: center;
        gap: 10px;
        color: var(--primary-dark);
        font-size: 15px;
        font-weight: 500;
      }

      .selected-info i {
        color: var(--primary);
        font-size: 18px;
      }

      .form-container {
        background-color: var(--lighter);
        border-radius: 10px;
        padding: 20px;
        border: 1px solid var(--accent);
        margin-bottom: 15px;
      }

      .form-group {
        margin-bottom: 20px;
        position: relative;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: var(--primary-dark);
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .form-group label i {
        color: var(--secondary);
      }

      .form-group input {
        width: 100%;
        padding: 14px 16px;
        border-radius: 10px;
        border: 2px solid var(--border);
        background-color: var(--surface);
        color: var(--text);
        font-size: 15px;
        transition: all 0.3s ease;
      }

      .form-group input:focus {
        outline: none;
        border-color: var(--focus);
        box-shadow: 0 0 0 3px rgba(169, 206, 244, 0.3);
        background-color: var(--lighter);
      }

      .form-group input::placeholder {
        color: var(--text-light);
        opacity: 0.7;
      }

      .btn-confirm {
        background: linear-gradient(
          135deg,
          var(--primary),
          var(--primary-dark)
        );
        color: white;
        border: none;
        padding: 16px 24px;
        border-radius: 10px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        transition: all 0.3s ease;
        box-shadow: 0 5px 15px rgba(54, 73, 78, 0.25);
        width: 100%;
        margin-top: 10px;
        border: 1px solid var(--primary-dark);
      }

      .btn-confirm:hover {
        background: linear-gradient(
          135deg,
          var(--primary-dark),
          var(--secondary)
        );
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(54, 73, 78, 0.35);
      }

      .btn-confirm:active {
        transform: translateY(0);
      }

      .message {
        padding: 12px 16px;
        border-radius: 10px;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 14px;
        animation: fadeIn 0.4s ease;
        border-left: 4px solid transparent;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-5px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .message.info {
        background-color: rgba(169, 206, 244, 0.2);
        color: var(--primary-dark);
        border-color: var(--light);
      }

      .message.error {
        background-color: rgba(239, 68, 68, 0.15);
        color: var(--error);
        border-color: var(--error);
      }

      .message.success {
        background-color: rgba(16, 185, 129, 0.15);
        color: var(--success);
        border-color: var(--success);
      }

      .message.warning {
        background-color: rgba(245, 158, 11, 0.15);
        color: var(--pending);
        border-color: var(--pending);
      }

      .whatsapp-info {
        background-color: rgba(37, 211, 102, 0.15);
        color: #25d366;
        padding: 12px 16px;
        border-radius: 10px;
        margin-top: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 14px;
        border: 1px solid rgba(37, 211, 102, 0.3);
        border-left: 4px solid #25d366;
      }

      .pending-notice {
        background-color: rgba(245, 158, 11, 0.15);
        color: var(--pending);
        padding: 12px 16px;
        border-radius: 10px;
        margin-top: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 14px;
        border: 1px solid rgba(245, 158, 11, 0.3);
        border-left: 4px solid var(--pending);
      }

      /* Estados de días en el calendario */
      .calendar td.reserved-day::after {
        content: "✗";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 18px;
        color: var(--error);
        opacity: 0.8;
      }

      .calendar td.pending-day::after {
        content: "!";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 18px;
        color: var(--pending);
        opacity: 0.8;
      }

      .calendar td.unavailable-day::after {
        content: "—";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 18px;
        color: var(--unavailable);
        opacity: 0.8;
      }

      /* Separadores visuales */
      .section-divider {
        height: 2px;
        background: linear-gradient(
          to right,
          transparent,
          var(--light),
          transparent
        );
        margin: 20px 0;
        border: none;
      }

      .time-slot-divider {
        height: 1px;
        background: linear-gradient(
          to right,
          transparent,
          var(--accent),
          transparent
        );
        margin: 15px 0;
        border: none;
        grid-column: 1 / -1;
      }

      /* Responsive */
      @media (max-width: 640px) {
        .container {
          border-radius: 12px;
        }

        .header {
          padding: 20px 15px;
        }

        .logo {
          font-size: 24px;
        }

        .subtitle {
          font-size: 14px;
        }

        .calendar-container {
          padding: 15px;
        }

        .current-month {
          font-size: 18px;
        }

        .calendar th {
          font-size: 12px;
          padding: 10px 0;
        }

        .calendar td {
          height: 40px;
          padding: 8px 0;
        }

        .day-number {
          width: 32px;
          height: 32px;
          line-height: 32px;
          font-size: 13px;
        }

        .time-slots {
          grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
          gap: 8px;
        }

        .selected-info {
          flex-direction: column;
          gap: 12px;
          align-items: flex-start;
        }

        .btn-confirm {
          padding: 14px 20px;
          font-size: 15px;
        }

        .time-slot-divider {
          margin: 10px 0;
        }
      }

      @media (min-width: 641px) and (max-width: 768px) {
        .time-slots {
          grid-template-columns: repeat(auto-fill, minmax(85px, 1fr));
        }
      }

      /* Mejoras de accesibilidad */
      @media (prefers-reduced-motion: reduce) {
        * {
          animation-duration: 0.01ms !important;
          animation-iteration-count: 1 !important;
          transition-duration: 0.01ms !important;
        }
      }

      /* Focus visible para mejor accesibilidad */
      button:focus-visible,
      input:focus-visible {
        outline: 2px solid var(--focus);
        outline-offset: 2px;
      }

      /* Estados de carga */
      .btn-confirm:disabled {
        opacity: 0.7;
        cursor: not-allowed;
        transform: none;
      }

      /* Efecto de pulso para elementos importantes */
      @keyframes pulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
        100% {
          transform: scale(1);
        }
      }

      .pulse {
        animation: pulse 2s infinite;
      }

      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <div class="logo">#LODELTIRRY</div>
        <div class="subtitle">Reserva tu turno de manera fácil y rápida</div>
        <div class="price-tag" id="price-display">Precio: $2500</div>
      </div>

      <div class="calendar-container">
        <div class="calendar-header">
          <div class="month-nav">
            <button class="nav-btn" id="prev-month">
              <i class="fas fa-chevron-left"></i>
            </button>
          </div>

          <div class="current-month" id="current-month">Septiembre 2025</div>

          <div class="month-nav">
            <button class="nav-btn" id="next-month">
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>

        <table class="calendar">
          <thead>
            <tr>
              <th>Lun</th>
              <th>Mar</th>
              <th>Mié</th>
              <th>Jue</th>
              <th>Vie</th>
              <th>Sáb</th>
              <th>Dom</th>
            </tr>
          </thead>
          <tbody id="calendar-body"></tbody>
        </table>

        <div class="turns-section">
          <h3 class="turns-title">
            <i class="far fa-clock"></i>Turnos disponibles - 30 min
          </h3>
          <div id="selection-message" class="message info">
            <i class="fas fa-info-circle"></i> Selecciona una fecha para ver los
            horarios disponibles
          </div>
          <div class="time-slots" id="time-slots"></div>
        </div>

        <div class="confirmation-section" id="confirmation-section">
          <h3 class="confirmation-title">
            <i class="fas fa-calendar-check"></i> Confirmar reserva
          </h3>

          <div class="selected-info" id="selected-info"></div>

          <div class="form-group">
            <label for="client-name"
              ><i class="fas fa-user"></i>Nombre completo</label
            >
            <input
              type="text"
              id="client-name"
              placeholder="Ingresa tu nombre"
            />
          </div>

          <div class="form-group">
            <label for="client-phone"
              ><i class="fas fa-phone"></i>Número de teléfono</label
            >
            <input
              type="tel"
              id="client-phone"
              placeholder="Ingresa tu número de contacto"
            />
          </div>

          <div class="whatsapp-info">
            <i class="fab fa-whatsapp"></i> El mensaje se enviará al número:
            3534766211
          </div>

          <div class="pending-notice">
            <i class="fas fa-exclamation-circle"></i> La reserva solo se
            confirmará después de enviar el mensaje por WhatsApp
          </div>

          <button class="btn-confirm" id="btn-confirm">
            <i class="fab fa-whatsapp"></i> Enviar confirmación por WhatsApp
          </button>
        </div>
      </div>
    </div>

    <script>
      /* ---------------- DOM ---------------- */
      const calendarBody = document.getElementById("calendar-body");
      const timeSlotsContainer = document.getElementById("time-slots");
      const selectionMessage = document.getElementById("selection-message");
      const confirmationSection = document.getElementById(
        "confirmation-section"
      );
      const selectedInfo = document.getElementById("selected-info");
      const clientNameInput = document.getElementById("client-name");
      const clientPhoneInput = document.getElementById("client-phone");
      const btnConfirm = document.getElementById("btn-confirm");
      const prevMonthBtn = document.getElementById("prev-month");
      const nextMonthBtn = document.getElementById("next-month");
      const currentMonthEl = document.getElementById("current-month");
      const priceDisplay = document.getElementById("price-display");

      /* ---------------- Estado ---------------- */
      let selectedDate = null;
      let selectedTime = null;
      let currentDate = new Date();
      let currentMonth = currentDate.getMonth();
      let currentYear = currentDate.getFullYear();

      const BACKEND_URL = "https://gestor-turnos-yv0m.onrender.com";
      let useBackend = true; // si el backend responde usamos API, sino fallback a localStorage

      // Config locales (panel guarda esto en localStorage y además envía postMessage)
      let unavailableDays = JSON.parse(
        localStorage.getItem("unavailableDays") || "[1]"
      ); // lunes por defecto
      let availableTimes = JSON.parse(
        localStorage.getItem("availableTimes") || "{}"
      );

      /* ---------------- Inicio ---------------- */
      document.addEventListener("DOMContentLoaded", () => {
        generateCalendar(currentMonth, currentYear);
        setupEventListeners();
        checkBackendConnection();
        loadPrice();
      });

      /* ---------------- Comprobación backend ---------------- */
      async function checkBackendConnection() {
        try {
          const res = await fetch(`${BACKEND_URL}/health`);
          useBackend = res.ok;
        } catch (err) {
          useBackend = false;
        }
        if (!useBackend) {
          selectionMessage.textContent =
            "Modo local activado. Las reservas se guardarán localmente.";
          selectionMessage.className = "message warning";
        }
      }

      /* ---------------- Event listeners ---------------- */
      function setupEventListeners() {
        prevMonthBtn.addEventListener("click", () => {
          currentMonth--;
          if (currentMonth < 0) {
            currentMonth = 11;
            currentYear--;
          }
          generateCalendar(currentMonth, currentYear);
        });

        nextMonthBtn.addEventListener("click", () => {
          currentMonth++;
          if (currentMonth > 11) {
            currentMonth = 0;
            currentYear++;
          }
          generateCalendar(currentMonth, currentYear);
        });

        btnConfirm.addEventListener("click", confirmReservation);

        // Escuchar actualizaciones desde panel.html (postMessage)
        window.addEventListener("message", (event) => {
          const data = event.data;
          if (!data || !data.type) return;

          if (data.type === "priceUpdate") {
            priceDisplay.textContent = `Precio: $${data.price}`;
            localStorage.setItem("servicePrice", data.price);
          }

          if (data.type === "unavailableDaysUpdate") {
            unavailableDays = data.days || [];
            localStorage.setItem(
              "unavailableDays",
              JSON.stringify(unavailableDays)
            );
            generateCalendar(currentMonth, currentYear);
          }

          if (data.type === "availableTimesUpdate") {
            availableTimes = data.times || {};
            localStorage.setItem(
              "availableTimes",
              JSON.stringify(availableTimes)
            );
            if (selectedDate) generateTimeSlots(selectedDate);
          }
        });
      }

      /* ---------------- Calendario ---------------- */
      function generateCalendar(month, year) {
        calendarBody.innerHTML = "";
        currentMonthEl.textContent = `${getMonthName(month)} ${year}`;

        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();
        const startingDay = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1; // lunes como inicio

        let date = 1;
        for (let i = 0; i < 6; i++) {
          const row = document.createElement("tr");
          for (let j = 0; j < 7; j++) {
            const cell = document.createElement("td");

            if (i === 0 && j < startingDay) {
              cell.classList.add("inactive");
              const prevMonthDays = new Date(year, month, 0).getDate();
              cell.innerHTML = `<span class="day-number">${
                prevMonthDays - (startingDay - j - 1)
              }</span>`;
            } else if (date > daysInMonth) {
              cell.classList.add("inactive");
              cell.innerHTML = `<span class="day-number">${
                date - daysInMonth
              }</span>`;
              date++;
            } else {
              const cellDate = new Date(year, month, date);
              const today = new Date();

              // marcar hoy
              if (
                cellDate.getDate() === today.getDate() &&
                cellDate.getMonth() === today.getMonth() &&
                cellDate.getFullYear() === today.getFullYear()
              ) {
                cell.classList.add("today");
              }

              // fecha pasada
              if (
                cellDate <
                new Date(today.getFullYear(), today.getMonth(), today.getDate())
              ) {
                cell.classList.add("past");
              }

              // dias no disponibles por día de la semana (0=domingo..6=sábado)
              const weekday = cellDate.getDay();
              if (unavailableDays && unavailableDays.includes(weekday)) {
                cell.classList.add("unavailable-day");
              }

              cell.innerHTML = `<span class="day-number">${date}</span>`;

              // solo si no es pasado, inactivo, ni no disponible se puede clickear
              if (
                !cell.classList.contains("past") &&
                !cell.classList.contains("inactive") &&
                !cell.classList.contains("unavailable-day")
              ) {
                cell.addEventListener("click", () => selectDate(cellDate));
              }

              date++;
            }

            row.appendChild(cell);
          }
          calendarBody.appendChild(row);
        }

        // marcar días con reservas (async)
        markReservedDays(month, year);
      }

      /* marca como reserved-day los días que ya tienen reservas (opcional visual) */
      async function markReservedDays(month, year) {
        try {
          const reservations = await fetchReservations();
          const cells = calendarBody.querySelectorAll("td");
          // limpiar previas marcas de reserva
          cells.forEach((c) => c.classList.remove("reserved-day"));
          reservations.forEach((r) => {
            const d = new Date(r.date);
            if (d.getMonth() === month && d.getFullYear() === year) {
              cells.forEach((cell) => {
                if (
                  !cell.classList.contains("inactive") &&
                  parseInt(cell.textContent) === d.getDate()
                ) {
                  cell.classList.add("reserved-day");
                }
              });
            }
          });
        } catch (err) {
          // si falla, no pasa nada
          console.error("No se pudieron marcar días reservados:", err);
        }
      }

      /* ---------------- Utiles ---------------- */
      function getMonthName(month) {
        const months = [
          "Enero",
          "Febrero",
          "Marzo",
          "Abril",
          "Mayo",
          "Junio",
          "Julio",
          "Agosto",
          "Septiembre",
          "Octubre",
          "Noviembre",
          "Diciembre",
        ];
        return months[month];
      }

      function pad(n) {
        return n.toString().padStart(2, "0");
      }

      function formatDate(input) {
        // acepta Date o string 'YYYY-MM-DD'
        let d = input;
        if (!(d instanceof Date)) d = new Date(input);
        return `${pad(d.getDate())}/${pad(
          d.getMonth() + 1
        )}/${d.getFullYear()}`;
      }

      function isoDate(d) {
        // Date -> YYYY-MM-DD
        return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(
          d.getDate()
        )}`;
      }

      function normalizeTime(t) {
        // convierte '08:00' o '8:00' en '8:00' (para comparar)
        if (!t) return t;
        const [h, m] = t.split(":");
        return `${parseInt(h, 10)}:${m}`;
      }

      function showMessage(targetEl, text, type = "info") {
        targetEl.textContent = text;
        targetEl.className = `message ${type}`;
      }

      /* ---------------- Seleccionar fecha ---------------- */
      async function selectDate(date) {
        selectedDate = date;
        selectedTime = null;

        // quitar active
        const allCells = calendarBody.querySelectorAll("td");
        allCells.forEach((cell) => cell.classList.remove("active"));

        const day = date.getDate();
        const cells = calendarBody.querySelectorAll("td");
        cells.forEach((cell) => {
          if (
            parseInt(cell.textContent) === day &&
            !cell.classList.contains("inactive")
          ) {
            cell.classList.add("active");
          }
        });

        showMessage(
          selectionMessage,
          `Seleccionaste el día ${formatDate(date)}`,
          "info"
        );
        await generateTimeSlots(date);
        confirmationSection.style.display = "none";
      }

      /* ---------------- Generar slots de tiempo ---------------- */
      async function generateTimeSlots(date) {
        timeSlotsContainer.innerHTML = "";
        try {
          // obtener horarios reservados para la fecha
          let reservedTimes = [];

          if (useBackend) {
            try {
              const reservations = await fetchReservations();
              reservedTimes = reservations
                .filter(
                  (r) => new Date(r.date).toDateString() === date.toDateString()
                )
                .map((r) => normalizeTime(r.time));
            } catch (err) {
              console.error("Error obteniendo reservas del backend:", err);
              useBackend = false;
              showMessage(
                selectionMessage,
                "Modo local activado. Las reservas se guardarán localmente.",
                "warning"
              );
            }
          }

          if (!useBackend) {
            const localReservations = JSON.parse(
              localStorage.getItem("reservations") || "[]"
            );
            reservedTimes = localReservations
              .filter(
                (r) => new Date(r.date).toDateString() === date.toDateString()
              )
              .map((r) => normalizeTime(r.time));
          }

          // horarios permitidos para ese día (por configuración)
          const dayKey = date.getDay().toString(); // 0..6
          let times = availableTimes[dayKey] || [];

          // si no hay configuración definida, generamos por defecto 8:00 a 19:30 cada 30'
          if (!times || times.length === 0) {
            times = [];
            for (let hour = 8; hour <= 19; hour++) {
              times.push(`${hour}:00`);
              if (hour < 19) times.push(`${hour}:30`);
            }
          }

          // Crear slots
          times.forEach((displayTime) => {
            const normalized = normalizeTime(displayTime);
            const timeSlot = document.createElement("div");
            timeSlot.classList.add("time-slot");
            timeSlot.textContent = displayTime;

            if (reservedTimes.includes(normalized)) {
              timeSlot.classList.add("reserved");
              timeSlot.textContent = displayTime;
            } else {
              timeSlot.addEventListener("click", () => {
                selectTime(displayTime, timeSlot);
              });
            }

            timeSlotsContainer.appendChild(timeSlot);
          });
        } catch (error) {
          showMessage(
            selectionMessage,
            "Error al cargar los horarios. Intenta nuevamente.",
            "error"
          );
          console.error("Error:", error);
        }
      }

      /* ---------------- Seleccionar hora ---------------- */
      function selectTime(time, elem) {
        selectedTime = time;

        // limpiar selección previa
        const all = timeSlotsContainer.querySelectorAll(".time-slot");
        all.forEach((t) => t.classList.remove("selected"));

        // marcar seleccionado
        if (elem) elem.classList.add("selected");

        selectedInfo.innerHTML = `
    <div class="selected-date"><i class="fas fa-calendar"></i> ${formatDate(
      selectedDate
    )}</div>
    <div class="selected-time"><i class="fas fa-clock"></i> ${time}</div>
  `;
        confirmationSection.style.display = "block";
      }

      /* ---------------- Confirmar reserva ---------------- */
      async function confirmReservation() {
        if (!selectedDate || !selectedTime) {
          showMessage(
            selectionMessage,
            "Seleccioná fecha y hora antes de confirmar.",
            "error"
          );
          return;
        }

        const clientName = clientNameInput.value.trim();
        const phone = clientPhoneInput.value.trim();

        if (!clientName || !phone) {
          showMessage(selectionMessage, "Completá nombre y teléfono.", "error");
          return;
        }

        const reservation = {
          clientName,
          phone,
          date: isoDate(selectedDate), // YYYY-MM-DD
          time: selectedTime,
          reservationDate: new Date().toISOString(),
          status: "confirmed",
        };

        // intentar guardar en backend
        if (useBackend) {
          try {
            const res = await fetch(`${BACKEND_URL}/api/reservations`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(reservation),
            });

            if (!res.ok) throw new Error("Error creando reserva en backend");

            // OK
            showMessage(
              selectionMessage,
              "Reserva creada correctamente. Enviá la confirmación por WhatsApp.",
              "success"
            );

            // refrescar slots para marcar como reservado
            await generateTimeSlots(selectedDate);
            confirmationSection.style.display = "none";

            // abrir WhatsApp (opcional) con mensaje prellenado
            const whatsappNumber = "3534766211";
            const text = encodeURIComponent(
              `Hola, quiero confirmar mi reserva. Nombre: ${clientName} - Fecha: ${formatDate(
                selectedDate
              )} - Hora: ${selectedTime}`
            );
            window.open(
              `https://wa.me/${whatsappNumber}?text=${text}`,
              "_blank"
            );
            return;
          } catch (err) {
            console.error("Error al crear reserva en backend:", err);
            // pasar a fallback local
            useBackend = false;
            showMessage(
              selectionMessage,
              "No se pudo conectar al servidor. Guardando reserva en local.",
              "warning"
            );
          }
        }

        // fallback: guardar en localStorage
        try {
          const reservations = JSON.parse(
            localStorage.getItem("reservations") || "[]"
          );
          // id simple timestamp
          reservation.id = Date.now().toString();
          reservations.push(reservation);
          localStorage.setItem("reservations", JSON.stringify(reservations));

          showMessage(
            selectionMessage,
            "Reserva guardada en modo local. Enviá la confirmación por WhatsApp.",
            "success"
          );

          // refrescar slots y cerrar confirmación
          await generateTimeSlots(selectedDate);
          confirmationSection.style.display = "none";

          const whatsappNumber = "3534766211";
          const text = encodeURIComponent(
            `Hola, quiero confirmar mi reserva. Nombre: ${clientName} - Fecha: ${formatDate(
              selectedDate
            )} - Hora: ${selectedTime}`
          );
          window.open(`https://wa.me/${whatsappNumber}?text=${text}`, "_blank");
        } catch (err) {
          console.error("Error guardando en local:", err);
          showMessage(
            selectionMessage,
            "No se pudo guardar la reserva.",
            "error"
          );
        }
      }

      /* ---------------- API Reservas ---------------- */
      async function fetchReservations() {
        // devuelve array de reservas (backend o local)
        if (useBackend) {
          try {
            const res = await fetch(`${BACKEND_URL}/api/reservations`);
            if (!res.ok) throw new Error("Error al obtener reservas");
            return await res.json();
          } catch (err) {
            console.error("Error fetching reservations:", err);
            useBackend = false;
            return JSON.parse(localStorage.getItem("reservations") || "[]");
          }
        } else {
          return JSON.parse(localStorage.getItem("reservations") || "[]");
        }
      }

      /* ---------------- PRECIO ---------------- */
      async function loadPrice() {
        // intenta backend -> fallback localStorage -> fallback 2500
        try {
          const res = await fetch(`${BACKEND_URL}/api/config`);
          if (!res.ok) throw new Error("No hay config");
          const data = await res.json();
          priceDisplay.textContent = `Precio: $${data.price}`;
        } catch (err) {
          console.warn(
            "No se pudo cargar precio desde backend, usando localStorage o valor por defecto.",
            err
          );
          const saved = localStorage.getItem("servicePrice") || "2500";
          priceDisplay.textContent = `Precio: $${saved}`;
        }
      }
    </script>
  </body>
</html>
